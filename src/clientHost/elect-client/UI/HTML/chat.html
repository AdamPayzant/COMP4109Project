<!DOCTYPE HTML>
<html>
    <head>
        <title>Hello World</title>

        <link rel="stylesheet" type="text/css" href="../CSS/chat.css" />
        <link rel="stylesheet" type="text/css" href="../CSS/style.css" />

    </head>

    <body>

        <!-- Test Window -->
 
        <!-- Text Window -->
        <!--<div class="chatContainer"></div> -->
            <div class="chatContainer TextWindow " id="output"></div>


        <!-- Text Input -->
        <div class="inputArea" style="display: grid; grid-template-columns: auto 100px; height: calc(100% - 10px); width: calc(100% - 10px);">
            <textarea rows="4" cols="50"  id="input" type="text"  style="grid-column: 1; resize:none; font-size:larger;"></textarea>
            <button onclick="send()" style="grid-column: 2;">Send</button>
        </div>
        
        <!-- Side Bar -->
        <div class="sidebar">

            <div style="grid-row: 1;" id="returnArea" class="standardPadding">
            <button style="height: 100%; width: 100%;" class="" onclick="moveScreens('menu')"> To Main Menu &rarr; </button>
            </div>

            <!-- Client Login -->
            <div style="grid-row: 2; grid-template-columns:70px 160px; grid-template-rows: 20px 60px;" id="area1" class="sidebarItem standardPadding">
                <div style="grid-area: 1 / 1; " class="textFeild"> 
                    <div class="centeredText">Profile</div> 
                </div> 

                <div style="grid-area: 2 / 1 / 3 / 3; display: grid; grid-gap: 2px; grid-template-columns: 70px 160px; grid-template-rows: auto auto;">
                    
                    <div style="grid-area: 1 / 1; " class="textFeild">  
                        <div class="centeredText">Alias</div> 
                    </div> 
                    <div style="grid-area: 1 / 2; " class="textFeild"> 12345678 </div>

                    <div style="grid-area: 2 / 1; " class="textFeild">  
                        <div class="centeredText">Public Key</div> 
                    </div> 
                    <div style="grid-area: 2 / 2; " class="textFeild"> 12345678 </div>

                </div>

                
            </div>

            <!-- Area 1 -->
            <div style="grid-row: 3; grid-template-columns: 70px 160px; grid-template-rows: 20px 120px 20px;" id = "area2" class="sidebarItem standardPadding">
                <div style="grid-area: 1 / 1; " class="textFeild"> 
                    <div class="centeredText">Other Client</div> 
                </div> 

                <div style="grid-area: 2 / 1 / 3 / 3; display: grid; grid-gap: 2px; grid-template-columns: 70px 160px; grid-template-rows: auto auto auto auto;">
                    
                    <div style="grid-area: 1 / 1; " class="textFeild">  
                        <div class="centeredText">Alias</div> 
                    </div> 
                    <div style="grid-area: 1 / 2; "  class="textFeild"> 12345678 </div>

                    <div style="grid-area: 2 / 1; "  class="textFeild">  
                        <div class="centeredText">Public Key</div> 
                    </div> 
                    <div style="grid-area: 2 / 2; "  class="textFeild"> 12345678 </div>

                    <div style="grid-area: 3 / 1; "  class="textFeild">  
                        <div class="centeredText">IP</div> 
                    </div> 
                    <div style="grid-area: 3 / 2; " class="textFeild"> 12345678 </div>

                    <div style="grid-area: 4 / 1; " class="textFeild">  
                        <div class="centeredText">Status</div> 
                    </div> 
                    <div style="grid-area: 4 / 2; " class="textFeild"> Connected </div>

                </div>

                <button style="grid-area: 3 / 2; height: 100%; width: 100%;"> Disconnect </button>

            </div>
            
            <!-- Area 2 -->
            <div style="grid-row: 4; grid-template-columns:70px 160px; grid-template-rows: 20px 60px 20px;" id = "area3" class="sidebarItem standardPadding">
                <div style="grid-area: 1 / 1; "  class="textFeild"> 
                    <div class="centeredText">Host</div> 
                </div> 

                <div style="grid-area: 2 / 1 / 3 / 3; display: grid; grid-gap: 1px; grid-template-columns: 70px 160px; grid-template-rows: auto auto;">
                    
                    <div style="grid-area: 1 / 1; "  class="textFeild">  
                        <div class="centeredText">IP</div> 
                    </div> 
                    <div style="grid-area: 1 / 2; "  class="textFeild"> 12345678 </div>

                    <div style="grid-area: 2 / 1; "  class="textFeild">  
                        <div class="centeredText">Status</div> 
                    </div> 
                    <div style="grid-area: 2 / 2; "  class="textFeild"> 12345678 </div>

                </div>

                <button style="grid-area: 3 / 2;"> Disconnect </button>
            </div>

            <!-- Area 3 -->
            <div style="grid-row: 5; width: 100%; height:100%; display: grid; grid-row-gap: 5px; grid-template-columns:auto; grid-template-rows: 20px auto;" id = "area4" class="standardPadding">
                <div style="grid-area: 1 / 1; "  class="textFeild"> 
                    <div class="centeredText">Additional Functions</div> 
                </div> 

                <div style="grid-area: 2 / 1 / 3 / 3; display: grid; grid-gap: 5px; grid-template-columns: auto auto; grid-template-rows: 25px 25px 25px;">
                    <button style="grid-area: 1 / 1;"> Export To JSON </button>
                    <button style="grid-area: 1 / 2;"> Export To JSON </button>

                    <button style="grid-area: 2 / 1;"> </button>
                    <button style="grid-area: 2 / 2;"> </button>

                    <button style="grid-area: 3 / 1;"> </button>
                    <button style="grid-area: 3 / 2;"> </button>

                </div>

            </div>

            <!-- Web Connection -->
            <div  style="grid-row: 6; display: none;" id = "clinetSatus" class="standardPadding"></div>
            <!--<div  style="grid-row: 6;" id = "void" class="standardPadding"></div> -->

        </div>


        <div id="contextMenu" class="context-menu" style="display: none"> </div> 
        <input id="clipboard" type="text" action="none" style="display: none"> </input> 

        <script>

            var input = document.getElementById("input");
            var output = document.getElementById("output");
            var statusArea = document.getElementById("clinetSatus");
            const { ipcRenderer, clipboard } = require("electron")

            let connectionData = {"network": "", "port": "", "username": ""};
            let chatHistory = null
            
            //setLoginArea(0);

            function postToChat(e){
                output.innerHTML += formatMessageForDisplay(e)
                console.log(JSON.stringify(e))
                /*if(e.userid == -1)*/
                document.getElementById(`chatMessage${e.order}`).oncontextmenu = (ev)=>{rightClick(ev, e.order);};
            }

            function formatMessageForDisplay(message){

                let chatID = message.speaker || 0
                let chatMSG = message.messageText || ""
                let msgType = "chatBubbleClient"
                let msgID = message.order 

                let msgColor = 1;

                if(chatID == -1){
                    msgColor = 0;
                    msgType = "chatBubbleUser"
                } else {
                    msgColor = (chatID % 11) + 1
                }

                return `<div onmouseover="setUpContextMenu(${msgID})" id="chatMessage${msgID}" class="chatBubbleOuter">
                        <div class="colormarkerOuter"> <div class="chatBubble${""+msgColor} colormarkerInner">  </div></div>
                        <pre title="1" class="${msgType} chatBubbleInner" style="margin:0px">${chatMSG}</pre>
                        </div`
            }

            function setUpContextMenu(msgID){
                document.getElementById('contextMenu').innerHTML = `<ul> 
                        <li onclick="deleteMsg(${msgID})" ><a href="#">Delete</a></li> 
                        <li onclick="copyText(${msgID})" ><a href="#">Copy Text</a></li> 
                        <li onclick="copyMessage(${msgID})" ><a href="#">Copy Message (JSON)</a></li> 
                    </ul>`
                document.getElementById(`chatMessage${msgID}`).oncontextmenu = msgContextMenu;
            }

            function setLoginArea(value, message){    
                //Status connected
                if (value == 0) {
                    statusArea.innerHTML =
                    `<div style="display:inline-grid; grid-gap: 2%; grid-template-columns: 150px 75px; grid-template-rows: auto auto auto; height: 80%; position:relative; top: 20%">
                        <div style="grid-column: 1 / 2; grid-row: 2;"> Connection Success </div>
                        <button style="grid-column: 2; grid-row: 2;" onclick='disconnectClient()'> Leave </button>
                    </div>`;

                //Status Disconnected
                } else if (value == 1) {
                    statusArea.innerHTML =
                    `<div style="display:inline-grid; grid-gap: 2%; grid-template-columns: 150px 75px; grid-template-rows: auto auto auto; height: 80%; position:relative; top: 20%">
                        <div style="grid-column: 1 / 2; grid-row: 2;"> Disconnected </div>
                        <button style="grid-column: 2; grid-row: 2;" onclick='disconnectClient()'> Retry </button>
                    </div>`

                //Login Failed
                } else if (value == 2) {
                    statusArea.innerHTML =
                    `<div style="display:inline-grid; grid-gap: 2%; grid-template-columns: 150px 75px; grid-template-rows: auto auto auto; height: 80%; position:relative; top: 20%">
                        <div style="grid-column: 1 / 2; grid-row: 2;"> Connection Failed : ${message}  </div>
                        <button style="grid-column: 2; grid-row: 2;" onclick='disconnectClient()'> Retry </button>
                    </div>`

                //Default option    
                } else {
                    setLoginArea(0)
                }
            }

            /*##################################*\
                Application functions
            \*##################################*/

            function moveScreens(loc){
                ipcRenderer.send('moveTo', loc)
            }
            function disconnectClient(){
                moveScreens('login')
            }
            function send() {
                let message = {"functionClass":"chat", "functionName":"echo", "payload":input.value}
                input.value = "";
                sendChat(message)
            }
            function copyText(msgID){
                clipboard.writeText(chatHistory.messages.filter((e)=>{return e.order == msgID})[0].messageText)
            }
            function copyMessage(msgID){
                clipboard.writeText(JSON.stringify(chatHistory.messages.filter((e)=>{return e.order == msgID})[0]))
            }

            /*##################################*\
                IPC Calls
            \*##################################*/
            function sendChat(message){
                ipcRenderer.send('chatSent', message)
            }
            function deleteMsg(msgID){
                if(confirm("Are you sure that you want to delete this message?")){
                    document.getElementById(`chatMessage${msgID}`).remove()
                    ipcRenderer.send('deleteMSG', msgID)
                    chatHistory.messages = chatHistory.messages.filter((e)=>{return e.order != msgID})
                }
            }
            function loginAttempt(message){
                ipcRenderer.send('loginAttempt', message);
                //setLoginArea(1)                
            }

            /*##################################*\
                IPC Events
            \*##################################*/
            ipcRenderer.on('inBoundChat', (event, messageText)=>{
                postToChat(messageText)
                chatHistory.messages.push(messageText)
            })

            ipcRenderer.on('loginStatus', (event, result)=>{

                if(result){
                    //setLoginArea(0)
                }else{
                    //setLoginArea(1, "Incorrect password")
                }
            })

            /*##################################*\
                Start Functions
            \*##################################*/
            function start(){

                chatHistory = ipcRenderer.sendSync('fetch', 'activeChat')

                for (x of chatHistory.messages)
                    postToChat(x)

            }

            start();

            /*##################################*\
                Context Menu Functions
            \*##################################*/
            document.onclick = hideMenu;

            function hideMenu() { 
                document.getElementById( 
                    "contextMenu").style.display = "none" 
            } 

            function msgContextMenu(e) { 
                e.preventDefault(); 

                if (document.getElementById("contextMenu").style.display == "block") {
                    hideMenu();
                } else { 
                    var menu = document.getElementById("contextMenu") 
                        
                    menu.style.display = 'block'; 
                    menu.style.left = e.pageX + "px"; 
                    menu.style.top = e.pageY + "px"; 
                } 
            } 
        </script> 

    </body>

</html>