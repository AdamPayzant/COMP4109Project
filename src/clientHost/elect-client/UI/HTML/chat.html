<!DOCTYPE HTML>
<html>
    <head>
        <title>Hello World</title>

        <link rel="stylesheet" type="text/css" href="../CSS/chat.css" />
        <link rel="stylesheet" type="text/css" href="../CSS/style.css" />

    </head>

    <body>

        <!-- Test Window -->
 
        <!-- Text Window -->
        <!--<div class="chatContainer"></div> -->
            <div class="chatContainer TextWindow " id="output"></div>


        <!-- Text Input -->
        <div class="inputArea">
            <input id="input" type="text" />
            <button onclick="send()">Send</button>
        </div>
        
        <!-- Side Bar -->
        <div class="sidebar">

            <!-- Client Login -->
            <div style="grid-row: 1; grid-column: 1; " id="clinetSatus" class="standardPadding"></div>

            <!-- Area 1 -->
            <div style="grid-row: 2; grid-column: 1;" id = "area1" class="standardPadding"> </div>
            
            <!-- Area 2 -->
            <div style="grid-row: 3; grid-column: 1;" id = "area2" class="standardPadding"> </div>

            <!-- Area 3 -->
            <div style="grid-row: 4; grid-column: 1;" id = "area3" class="standardPadding"> s </div>

            <!-- Web Connection -->
            <div  style="grid-row: 5; grid-column: 1;" id = "area4" class="standardPadding"> </div>

        </div>


        <div id="contextMenu" class="context-menu" style="display: none"> </div> 
        <input id="clipboard" type="text" action="none" style="display: none"> </input> 

        <script>

            var input = document.getElementById("input");
            var output = document.getElementById("output");
            var statusArea = document.getElementById("clinetSatus");
            const { ipcRenderer } = require("electron")

            let connectionData = {"network": "", "port": "", "username": ""};
            let chatHistory = null
            
            setLoginArea(0);

            function postToChat(e){
                output.innerHTML += formatMessageForDisplay(e)
                console.log(JSON.stringify(e))
                /*if(e.userid == -1)*/
                document.getElementById(`chatMessage${e.order}`).oncontextmenu = (ev)=>{rightClick(ev, e.order);};
            }

            function formatMessageForDisplay(message){

                let chatID = message.speaker || 0
                let chatMSG = message.messageText || ""
                let msgType = "chatBubbleClient"
                let msgID = message.order 

                let msgColor = 1;

                if(chatID == -1){
                    msgColor = 0;
                    msgType = "chatBubbleUser"
                } else {
                    msgColor = (chatID % 11) + 1
                }

                return `<div onmouseover="setUpContextMenu(${msgID})" id="chatMessage${msgID}" class="chatBubbleOuter">
                        <div class="colormarkerOuter"> <div class="chatBubble${""+msgColor} colormarkerInner">  </div></div>
                        <div title="1" class="${msgType} chatBubbleInner"> 
                            ${chatMSG}
                        </div>
                        </div`
            }

            function setUpContextMenu(msgID){

                document.getElementById('contextMenu').innerHTML = `<ul> 
                        <li onclick="deleteMsg(${msgID})" ><a href="#">Delete</a></li> 
                        <li onclick="copyText(${msgID})" ><a href="#">Copy Text</a></li> 
                        <li onclick="copyMessage(${msgID})" ><a href="#">Copy Message (JSON)</a></li> 
                    </ul>`
                document.getElementById(`chatMessage${msgID}`).oncontextmenu = msgContextMenu;

            }

            function setLoginArea(value, message){    
                //Status connected
                if (value == 0) {
                    statusArea.innerHTML =
                    `<div style="display:inline-grid; grid-gap: 2%; grid-template-columns: 150px 75px; grid-template-rows: auto auto auto; height: 80%; position:relative; top: 20%">
                        <div style="grid-column: 1 / 2; grid-row: 2;"> Connection Success </div>
                        <button style="grid-column: 2; grid-row: 2;" onclick='disconnectClient()'> Leave </button>
                    </div>`;

                //Status Disconnected
                } else if (value == 1) {
                    statusArea.innerHTML =
                    `<div style="display:inline-grid; grid-gap: 2%; grid-template-columns: 150px 75px; grid-template-rows: auto auto auto; height: 80%; position:relative; top: 20%">
                        <div style="grid-column: 1 / 2; grid-row: 2;"> Disconnected </div>
                        <button style="grid-column: 2; grid-row: 2;" onclick='disconnectClient()'> Retry </button>
                    </div>`

                //Login Failed
                } else if (value == 2) {
                    statusArea.innerHTML =
                    `<div style="display:inline-grid; grid-gap: 2%; grid-template-columns: 150px 75px; grid-template-rows: auto auto auto; height: 80%; position:relative; top: 20%">
                        <div style="grid-column: 1 / 2; grid-row: 2;"> Connection Failed : ${message}  </div>
                        <button style="grid-column: 2; grid-row: 2;" onclick='disconnectClient()'> Retry </button>
                    </div>`

                //Default option    
                } else {
                    setLoginArea(0)
                }
            }
            
            function disconnectClient(){
                ipcRenderer.send('moveTo', 'login')
            }



            function send() {

                let message = {"functionClass":"chat", "functionName":"echo", "payload":input.value}
                input.value = "";
                sendChat(JSON.stringify(message))

            }


            function sendChat(message){
                ipcRenderer.send('chatSent', message)
            }

            function deleteMsg(msgID){

                if(confirm("Are you sure that you want to delete this message?")){
                    document.getElementById(`chatMessage${msgID}`).remove()
                    ipcRenderer.send('deleteMSG', msgID)
                    chatHistory.messages = chatHistory.messages.filter((e)=>{return e.order != msgID})
                }

            }

            const { clipboard } = require('electron')

            function copyText(msgID){
                clipboard.writeText(chatHistory.messages.filter((e)=>{return e.order == msgID})[0].messageText)
            }

            function copyMessage(msgID){
                clipboard.writeText(JSON.stringify(chatHistory.messages.filter((e)=>{return e.order == msgID})[0]))
            }


            function loginAttempt(message){
                ipcRenderer.send('loginAttempt', message);
                setLoginArea(1)                
            }

            ipcRenderer.on('inBoundChat', (event, messageText)=>{
                postToChat(messageText)
                chatHistory.messages.push(messageText)
            })

            ipcRenderer.on('loginStatus', (event, result)=>{

                if(result){
                    setLoginArea(0)
                }else{
                    setLoginArea(1, "Incorrect password")
                }
            })

            function start(){

                chatHistory = ipcRenderer.sendSync('fetch', 'activeChat')

                for (x of chatHistory.messages)
                    postToChat(x)

            }

            start();


            /**\
             * Context Menu Functions
            \**/
            document.onclick = hideMenu; 
            //document.oncontextmenu = hideMenu; 

            function hideMenu() { 
                document.getElementById( 
                    "contextMenu").style.display = "none" 
            } 

            function msgContextMenu(e) { 
                e.preventDefault(); 

                if (document.getElementById("contextMenu").style.display == "block") {
                    hideMenu();
                } else { 
                    var menu = document.getElementById("contextMenu") 
                        
                    menu.style.display = 'block'; 
                    menu.style.left = e.pageX + "px"; 
                    menu.style.top = e.pageY + "px"; 
                } 
            } 
        </script> 

    </body>

</html>